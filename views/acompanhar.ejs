<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" href="/img/logo_icone.svg" type="image/png">
    <title>Acompanhar demanda - Mídia Ideal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="/node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" integrity="sha384-4LISF5TTJX/fLmGSxO53rV4miRxdg84mZsxmO8Rx5jGtp/LbrixFETvWa5a6sESd" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/solicitacao.css">

    <title>Mídia Ideal</title>
</head>
<body class="bodySolicitacao">
    <div class="container">
        <div class="row">
            <div class="col-2">
                <img src="/img/botãoPrev.svg" alt="logo branca Mídia Ideal" class="mt-3" onclick="voltarNavegador()">
            </div>
            <div class="col-8 solicitacao">
                <img src="/img/logoMidia.png" class="img-fluid" width="30%">
                <div class="row">
                    <span> Olá <strong> <%= demanda.nome %> </strong>, veja como está o status da sua solicitação, clicando em ver mais você pode também ver mais informações sobre a sua solicitação</span>
                </div>
                <div class="numeroSolicitacao">Nº <%= numeroSolicitacao %></div>
                <% if(dataEntrega) { %>
                    <div class="previsaoEntrega">Data prevista para entrega: <strong><%= dataEntrega %> </strong> </div>
                <% } %>
                <div class="status-bar">
                    <% if(status === 'RECUSADA') { %>
                            <div class="status-column">
                                <i class="bi bi-envelope-arrow-down ativo"></i>
                                <span> Solicitação <br> recebida</span>
                            </div>
                            <div class="status-column">
                                <i class="bi bi-x-lg naoAceita"></i>
                                <span> Solicitação <br> não aceita</span>
                            </div>
                            <div class="status-column">
                                <i class="bi bi-hand-thumbs-up"></i>
                                <span> Solicitação <br> aceita</span>
                            </div>
                            <div class="status-column">
                                <i class="bi bi-kanban"></i>
                                <span> Em produção </span>
                            </div>
                            <div class="status-column">
                                <i class="bi bi-clock-history"></i>
                                <span> Aguardando <br> aprovação </span>
                            </div>
                            <div class="status-column">
                                <i class="bi bi-check-lg"></i>
                                <span> Aprovado </span>
                            </div>
                            <div class="status-column">
                                <i class="bi bi-envelope-check"></i>
                                <span> Entregue </span>
                            </div>
                        </div>
                    <% } %>
                    <% if(status === 'ENVIADA') { %>
                        <div class="status-column">
                            <i class="bi bi-envelope-arrow-down ativo"></i>
                            <span> Solicitação <br> recebida</span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-hand-thumbs-up"></i>
                            <span> Solicitação <br> aceita</span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-kanban"></i>
                            <span> Em produção </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-clock-history"></i>
                            <span> Aguardando <br> aprovação </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-check-lg"></i>
                            <span> Aprovado </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-envelope-check"></i>
                            <span> Entregue </span>
                        </div>
                    <% } %>
                    <% if(status === 'RECEBIDA') { %>
                        <div class="status-column">
                            <i class="bi bi-envelope-arrow-down ativo"></i>
                            <span> Solicitação <br> recebida</span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-hand-thumbs-up ativo"></i>
                            <span> Solicitação <br> aceita</span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-kanban"></i>
                            <span> Em produção </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-clock-history"></i>
                            <span> Aguardando <br> aprovação </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-check-lg"></i>
                            <span> Aprovado </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-envelope-check"></i>
                            <span> Entregue </span>
                        </div>
                    <% } %>
                    <% if(status === 'PRODUÇÃO') { %>
                        <div class="status-column">
                            <i class="bi bi-envelope-arrow-down ativo"></i>
                            <span> Solicitação <br> recebida</span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-hand-thumbs-up ativo"></i>
                            <span> Solicitação <br> aceita</span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-kanban ativo"></i>
                            <span> Em produção </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-clock-history"></i>
                            <span> Aguardando <br> aprovação </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-check-lg"></i>
                            <span> Aprovado </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-envelope-check"></i>
                            <span> Entregue </span>
                        </div>
                    <% } %>
                    <% if(status === 'APROVAÇÃO') { %>
                        <div class="status-column">
                            <i class="bi bi-envelope-arrow-down ativo"></i>
                            <span> Solicitação <br> recebida</span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-hand-thumbs-up ativo"></i>
                            <span> Solicitação <br> aceita</span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-kanban ativo"></i>
                            <span> Em produção </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-clock-history ativo"></i>
                            <span> Aguardando <br> aprovação </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-check-lg"></i>
                            <span> Aprovado </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-envelope-check"></i>
                            <span> Entregue </span>
                        </div>
                    <% } %>
                    <% if(status === 'APROVADA') { %>
                        <div class="status-column">
                            <i class="bi bi-envelope-arrow-down ativo"></i>
                            <span> Solicitação <br> recebida</span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-hand-thumbs-up ativo"></i>
                            <span> Solicitação <br> aceita</span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-kanban ativo"></i>
                            <span> Em produção </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-clock-history ativo"></i>
                            <span> Aguardando <br> aprovação </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-check-lg ativo"></i>
                            <span> Aprovado </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-envelope-check"></i>
                            <span> Entregue </span>
                        </div>
                    <% } %>
                    <% if(status === 'ENTREGUE') { %>
                        <div class="status-column">
                            <i class="bi bi-envelope-arrow-down ativo"></i>
                            <span> Solicitação <br> recebida</span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-hand-thumbs-up ativo"></i>
                            <span> Solicitação <br> aceita</span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-kanban ativo"></i>
                            <span> Em produção </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-clock-history ativo"></i>
                            <span> Aguardando <br> aprovação </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-check-lg ativo"></i>
                            <span> Aprovado </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-envelope-check ativo"></i>
                            <span> Entregue </span>
                        </div>
                    <% } %>
                    <% if(status === 'ALTERAÇÃO') { %>
                        <div class="status-column">
                            <i class="bi bi-envelope-arrow-down ativo"></i>
                            <span> Solicitação <br> recebida</span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-hand-thumbs-up ativo"></i>
                            <span> Solicitação <br> aceita</span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-kanban ativo"></i>
                            <span> Em produção </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-clock-history ativo"></i>
                            <span> Aguardando <br> aprovação </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-check-lg ativo"></i>
                            <span> Aprovado </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-envelope-check ativo"></i>
                            <span> Entregue </span>
                        </div>
                        <div class="status-column">
                            <i class="bi bi-arrow-counterclockwise alteracao"></i>
                            <span> <strong> Alteração Solicitada </strong> </span>
                        </div>
                    <% } %>
                </div>
                <div class="row">
                    <% if(status === 'RECUSADA') { %>
                        <div class="motivoRecusa mb-3">
                            <p><strong>Motivo da Recusa: </strong>  <%= motivoRecusa %> </p>
                        </div> 
                    <% } %>
                    <% if(status === 'APROVAÇÃO') { %>
                        <div class="motivoRecusa mb-3">
                            <p><strong>OBSERVAÇÕES: </strong>  <%= demanda.textoAprovacao %> </p>
                        </div> 
                    <% } %>
                </div>
                <div class="row">
                    <button class="btn btn-primary verMais" type="button" onclick="toggleInfos()">
                        VER MAIS <i id="chevronIcon" class="bi bi-chevron-double-down"></i>
                    </button>
                    <% if(status === 'ENTREGUE') { %>
                        <button class="btn btn-secondary verDetalhesEntrega mt-3" type="button" data-numeroSolicitacao="<%= demanda.numeroSolicitacao %>" onclick="verEntrega(this)"> VER DETALHES DA ENTREGA
                        </button>
                    <% } %>
                </div>
            </div>
            <div class="col-8">
                
            </div>
        </div>
        <div class="maisInfos" style="display: none;"> 
            <%- include('maisInfosDemanda') %>
        </div>

        <div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">ENTREGA - Solicitação Nº <span id="numeroSolicitacaoTitulo"></span></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="numeroSolicitacaoInput">
                        <span> No link abaixo você poderá visualizar o material solicitado</span> </br>
                        <a href="<%= demanda.linkEntrega %>" target="_blank"> Clique aqui para visualizar o material no drive</a>
                        <div class="mb-3 mt-3">
                            <label for="alteracao" class="form-label text-align-center">SOLICITAR ALTERAÇÕES</label> <br>
                            <span> Após visualizar o material você pode solicitar alterações nesse campo abaixo e enviar, automaticamente o status passará para "em alteração" e seremos notificados para realizar as alterações</span>
                                <textarea class="form-control" id="alteracoes" name="alteracoes" rows="3"></textarea>
                                <span> <strong>IMPORTANTE:</strong> Após solicitação de alteração seu material será passado para produção novamente e terá um novo prazo de entrega</span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        <button type="button" class="btn btn-primary" onclick="solicitarAlteracoes()">Solicitar Alterações</button>
                    </div>
                    <div id="sucessAlert" class="alert alert-success alert-dismissible fade show" role="alert" style="display: none;">
                        <span>Alteração realizada com sucesso, aguarde, estamos atualizando a página ...</span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    <div id="customAlert" class="alert alert-danger alert-dismissible fade show" role="alert" style="display: none;">
                        <strong>Atenção!</strong> <span id="customAlertMessage"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                </div>
            </div>
        </div>
</body>
<script src="/node_modules/jquery/dist/jquery.min.js"></script>
<script src="/node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function toggleInfos() {
        var maisInfos = $('.maisInfos');
        var chevronIcon = $('#chevronIcon');

        // Alternar a exibição da div de informações adicionais
        maisInfos.toggle();

        // Alternar entre os ícones de chevron para cima e para baixo
        if (maisInfos.is(':visible')) {
            chevronIcon.removeClass('bi bi-chevron-double-down').addClass('bi bi-chevron-double-up');
        } else {
            chevronIcon.removeClass('bi bi-chevron-double-up').addClass('bi bi-chevron-double-down');
        }

        // Alternar o texto do botão entre "VER MAIS" e "ESCONDER"
        var buttonText = maisInfos.is(':visible') ? 'ESCONDER' : 'VER MAIS';
        $('.verMais').text(buttonText);
    }
    function voltarNavegador() {
        window.history.back();
    }
    var myModal;
    function verEntrega(button) {
        let numeroSolicitacao = button.dataset.numerosolicitacao;
        document.getElementById('numeroSolicitacaoInput').value = numeroSolicitacao;
        document.getElementById('numeroSolicitacaoTitulo').textContent = numeroSolicitacao;
        abrirModal();
    }
    function abrirModal() {
        myModal = new bootstrap.Modal(document.getElementById('myModal'), {
            keyboard: false
        });
        myModal.show();
    }
    function fecharModal() {
        myModal.hide();
    }

    function solicitarAlteracoes () {
        const numeroSolicitacao = document.getElementById('numeroSolicitacaoInput').value;
        const descricao = document.getElementById('alteracoes').value

        //console.log(numeroSolicitacao, descricao)

        fetch(`/solicitacaoAlteracao/${numeroSolicitacao}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ descricao: descricao })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById("sucessAlert").style.display = "block";
            document.querySelector("#sucessAlert .btn-close").addEventListener("click", function() {
                document.getElementById("sucessAlert").style.display = "none";
            })
            setTimeout(function() {
                window.location.reload()
            }, 3000);
        })
        .catch(error => {
            console.error('Erro ao enviar dados:', error);
            exibirAlerta('Erro ao enviar alteração, entre em contato com nossa equipe via WhatsApp')
        });
    }

    function exibirAlerta(mensagem) {
        document.getElementById("customAlertMessage").textContent = mensagem;
        document.getElementById("customAlert").style.display = "block";
        document.querySelector("#customAlert .btn-close").addEventListener("click", function() {
        // Oculta o alerta quando o botão de fechar é clicado
            document.getElementById("customAlert").style.display = "none";
        })
    }

</script>

</html>